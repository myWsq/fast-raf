{"version":3,"file":"fast-raf.js","sources":["../fast-raf.ts"],"sourcesContent":["export type Event = (time: number) => void;\n\nexport type RafEventMap = Record<number, Event | null>;\n\ndeclare global {\n  interface Window {\n    FAST_RAF: {\n      map: RafEventMap;\n      count: number;\n    };\n  }\n}\n\nlet isHandlerPending = false;\n\nconst isSSR = typeof window === \"undefined\";\n\n/** Normalized raf */\nconst Raf =\n  !isSSR &&\n  (window.requestAnimationFrame || window.webkitRequestAnimationFrame);\n\nif (!isSSR) {\n  if (!window.FAST_RAF) {\n    window.FAST_RAF = {\n      map: {},\n      count: 0,\n    };\n  }\n}\n\n/**\n * Push an event into global event map. It will trigger the event handler,\n * all of the events in the same frame will be executed together.\n * @param event Event\n */\nfunction requestAnimationFrame(event: Event) {\n  const count = window.FAST_RAF.count + 1;\n  window.FAST_RAF.map[count] = event;\n  window.FAST_RAF.count = count - count;\n  eventHandler();\n  return count;\n}\n\n/**\n * Delete the event from global event map.\n * @param event Event\n */\n\nfunction cancelAnimationFrame(index: number) {\n  delete window.FAST_RAF.map[index];\n}\n\n/**\n * Flush event map. If push a new event in sub event, it should be called in next tick.\n */\nfunction eventConsumer(time: number) {\n  const curTickCount = window.FAST_RAF.count;\n  const map = window.FAST_RAF.map;\n  const curKeys = Object.keys(map);\n  for (const key of curKeys) {\n    const index = Number(key);\n    const e = map[index];\n    if (e) {\n      e(time);\n      delete map[index];\n    }\n  }\n  isHandlerPending = false;\n  const nextTickCount = window.FAST_RAF.count;\n  if (curTickCount !== nextTickCount) {\n    eventHandler();\n  }\n}\n\n/**\n * Create a new event consumer if one isn't pending.\n */\nfunction eventHandler() {\n  if (!Raf) {\n    throw new Error(\"window.requestAnimationFrame is undefined.\");\n  }\n  if (!isHandlerPending) {\n    isHandlerPending = true;\n    Raf(eventConsumer);\n  }\n}\n\nfunction register() {\n  if (!isSSR) {\n    window.requestAnimationFrame = requestAnimationFrame;\n    window.cancelAnimationFrame = cancelAnimationFrame;\n  }\n}\n\nregister();\n"],"names":["isHandlerPending","isSSR","window","Raf","requestAnimationFrame","webkitRequestAnimationFrame","FAST_RAF","map","count","event","eventHandler","cancelAnimationFrame","index","eventConsumer","time","curTickCount","curKeys","Object","keys","key","Number","e","nextTickCount","Error","register"],"mappings":";;;;EAaA,IAAIA,gBAAgB,GAAG,KAAvB;EAEA,IAAMC,KAAK,GAAG,OAAOC,MAAP,KAAkB,WAAhC;EAEA;;EACA,IAAMC,GAAG,GACP,CAACF,KAAD,KACCC,MAAM,CAACE,qBAAP,IAAgCF,MAAM,CAACG,2BADxC,CADF;;EAIA,IAAI,CAACJ,KAAL,EAAY;EACV,MAAI,CAACC,MAAM,CAACI,QAAZ,EAAsB;EACpBJ,IAAAA,MAAM,CAACI,QAAP,GAAkB;EAChBC,MAAAA,GAAG,EAAE,EADW;EAEhBC,MAAAA,KAAK,EAAE;EAFS,KAAlB;EAID;EACF;EAED;;;;;;;EAKA,SAASJ,qBAAT,CAA+BK,KAA/B;EACE,MAAMD,KAAK,GAAGN,MAAM,CAACI,QAAP,CAAgBE,KAAhB,GAAwB,CAAtC;EACAN,EAAAA,MAAM,CAACI,QAAP,CAAgBC,GAAhB,CAAoBC,KAApB,IAA6BC,KAA7B;EACAP,EAAAA,MAAM,CAACI,QAAP,CAAgBE,KAAhB,GAAwBA,KAAK,GAAGA,KAAhC;EACAE,EAAAA,YAAY;EACZ,SAAOF,KAAP;EACD;EAED;;;;;;EAKA,SAASG,oBAAT,CAA8BC,KAA9B;EACE,SAAOV,MAAM,CAACI,QAAP,CAAgBC,GAAhB,CAAoBK,KAApB,CAAP;EACD;EAED;;;;;EAGA,SAASC,aAAT,CAAuBC,IAAvB;EACE,MAAMC,YAAY,GAAGb,MAAM,CAACI,QAAP,CAAgBE,KAArC;EACA,MAAMD,GAAG,GAAGL,MAAM,CAACI,QAAP,CAAgBC,GAA5B;EACA,MAAMS,OAAO,GAAGC,MAAM,CAACC,IAAP,CAAYX,GAAZ,CAAhB;;EACA,8BAAkBS,OAAlB,8BAA2B;EAAtB,QAAMG,GAAG,eAAT;EACH,QAAMP,KAAK,GAAGQ,MAAM,CAACD,GAAD,CAApB;EACA,QAAME,CAAC,GAAGd,GAAG,CAACK,KAAD,CAAb;;EACA,QAAIS,CAAJ,EAAO;EACLA,MAAAA,CAAC,CAACP,IAAD,CAAD;EACA,aAAOP,GAAG,CAACK,KAAD,CAAV;EACD;EACF;;EACDZ,EAAAA,gBAAgB,GAAG,KAAnB;EACA,MAAMsB,aAAa,GAAGpB,MAAM,CAACI,QAAP,CAAgBE,KAAtC;;EACA,MAAIO,YAAY,KAAKO,aAArB,EAAoC;EAClCZ,IAAAA,YAAY;EACb;EACF;EAED;;;;;EAGA,SAASA,YAAT;EACE,MAAI,CAACP,GAAL,EAAU;EACR,UAAM,IAAIoB,KAAJ,CAAU,4CAAV,CAAN;EACD;;EACD,MAAI,CAACvB,gBAAL,EAAuB;EACrBA,IAAAA,gBAAgB,GAAG,IAAnB;EACAG,IAAAA,GAAG,CAACU,aAAD,CAAH;EACD;EACF;;EAED,SAASW,QAAT;EACE,MAAI,CAACvB,KAAL,EAAY;EACVC,IAAAA,MAAM,CAACE,qBAAP,GAA+BA,qBAA/B;EACAF,IAAAA,MAAM,CAACS,oBAAP,GAA8BA,oBAA9B;EACD;EACF;;EAEDa,QAAQ;;;;"}