{"version":3,"file":"fast-raf.js","sources":["../fast-raf.ts"],"sourcesContent":["export type Event = (time: number) => void;\n\nexport type RafEventMap = Record<number, Event | null>;\n\ndeclare global {\n  interface Window {\n    FAST_RAF: {\n      map: RafEventMap;\n      count: number;\n    };\n  }\n}\n\nlet isHandlerPending = false;\n\nconst isSSR = typeof window === \"undefined\";\n\n/** Normalized raf */\nconst Raf =\n  !isSSR &&\n  (window.requestAnimationFrame || window.webkitRequestAnimationFrame);\n\nif (!isSSR) {\n  if (!window.FAST_RAF) {\n    window.FAST_RAF = {\n      map: {},\n      count: 0,\n    };\n  }\n}\n\n/**\n * Push an event into global event map. It will trigger the event handler,\n * all of the events in the same frame will be executed together.\n * @param event Event\n */\nfunction requestAnimationFrame(event: Event) {\n  const count = window.FAST_RAF.count + 1;\n  window.FAST_RAF.map[count] = event;\n  window.FAST_RAF.count = count;\n  eventHandler();\n  return count;\n}\n\n/**\n * Delete the event from global event map.\n * @param event Event\n */\n\nfunction cancelAnimationFrame(index: number) {\n  delete window.FAST_RAF.map[index];\n}\n\n/**\n * Flush event map. If push a new event in sub event, it should be called in next tick.\n */\nfunction eventConsumer(time: number) {\n  const curTickCount = window.FAST_RAF.count;\n  const map = window.FAST_RAF.map;\n  const curKeys = Object.keys(map);\n  for (const key of curKeys) {\n    const index = Number(key);\n    const e = map[index];\n    if (e) {\n      e(time);\n      delete map[index];\n    }\n  }\n  isHandlerPending = false;\n  const nextTickCount = window.FAST_RAF.count;\n  if (curTickCount !== nextTickCount) {\n    eventHandler();\n  }\n}\n\n/**\n * Create a new event consumer if one isn't pending.\n */\nfunction eventHandler() {\n  if (!Raf) {\n    throw new Error(\"window.requestAnimationFrame is undefined.\");\n  }\n  if (!isHandlerPending) {\n    isHandlerPending = true;\n    Raf(eventConsumer);\n  }\n}\n\nfunction register() {\n  if (!isSSR) {\n    window.requestAnimationFrame = requestAnimationFrame;\n    window.cancelAnimationFrame = cancelAnimationFrame;\n  }\n}\n\nregister();\n"],"names":["isHandlerPending","isSSR","window","Raf","requestAnimationFrame","webkitRequestAnimationFrame","eventConsumer","time","curTickCount","FAST_RAF","count","map","Object","keys","index","Number","e","eventHandler","Error","event","cancelAnimationFrame"],"mappings":"6EAaA,IAAIA,GAAmB,EAEjBC,EAA0B,oBAAXC,OAGfC,GACHF,IACAC,OAAOE,uBAAyBF,OAAOG,6BAoC1C,SAASC,EAAcC,GAIrB,IAHA,IAAMC,EAAeN,OAAOO,SAASC,MAC/BC,EAAMT,OAAOO,SAASE,UACZC,OAAOC,KAAKF,kBACD,CAAtB,IACGG,EAAQC,aACRC,EAAIL,EAAIG,GACVE,IACFA,EAAET,UACKI,EAAIG,IAGfd,GAAmB,EAEfQ,IADkBN,OAAOO,SAASC,OAEpCO,IAOJ,SAASA,IACP,IAAKd,EACH,UAAUe,MAAM,8CAEblB,IACHA,GAAmB,EACnBG,EAAIG,IA9DHL,GACEC,OAAOO,WACVP,OAAOO,SAAW,CAChBE,IAAK,GACLD,MAAO,IA+DNT,IACHC,OAAOE,sBAtDX,SAA+Be,GAC7B,IAAMT,EAAQR,OAAOO,SAASC,MAAQ,EAItC,OAHAR,OAAOO,SAASE,IAAID,GAASS,EAC7BjB,OAAOO,SAASC,MAAQA,EACxBO,IACOP,GAkDLR,OAAOkB,qBA1CX,SAA8BN,UACrBZ,OAAOO,SAASE,IAAIG"}